sudo: false
language: node_js
node_js:
  - 12
scala: 2.12.10
jdk:
  - openjdk14
# if using Ubuntu 16 need this library
# https://github.com/cypress-io/cypress-documentation/pull/1647
addons:
  apt:
    packages:
    - libgconf-2-4
    
cache: 
  directories:
    - ~/.cache
    - ~/.cache/Cypress
    - $HOME/.m2/repository
    - $HOME/.sbt
    - $HOME/.ivy2
    - $HOME/backend

env:
  - APP_PORT=2551 CASSANDRA_CLUSTER_HOSTS=localhost CYPRESS_HOST=http://localhost:3000 CYPRESS_ENVIRONMENT=CI HMDA_RUNTIME_MODE=dev 

# Run the Platform
before_install:
  - "[ -d backend/.git ] || git clone https://github.com/cfpb/hmda-platform.git backend"
  - cd backend
  # Reset the repo so we can have a conflict-less pull
  - git reset --hard
  - git clean -f
  - git pull
  # Trick to avoid unnecessary cache updates
  - find $HOME/.sbt -name "*.lock" | xargs -r rm
  - sbt ++$TRAVIS_SCALA_VERSION  "project hmda-platform" "run" &
  - cd ..

install:
  - yarn install --offline

script:
  # Wait for the Platform to become available
  - ./cypress/wait-for-server.sh
  # Create each Institution (institutions.json) using the Platform configuration (PLATFORM_ENV)
  - yarn newman run cypress/ci/tests/CREATE_INSTITUTIONS.postman_collection.json -e cypress/ci/config/PLATFORM_ENV.postman_environment.json -d cypress/ci/config/institutions.json
  # Ensure cypress is available in Travis environment
  - cypress install
  # Start Frontend and run tests
  - REACT_APP_ENVIRONMENT=CI yarn start -p 3000 &
  - $(npm bin)/cypress run $CONFIG $RECORD
  # Cleanup
  - kill $(jobs -p) || true