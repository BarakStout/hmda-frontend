sudo: false
language: node_js
node_js:
  - 12
scala: 2.12.10
jdk:
  - openjdk14
# if using Ubuntu 16 need this library
# https://github.com/cypress-io/cypress-documentation/pull/1647
addons:
  apt:
    packages:
    - libgconf-2-4
    
cache: 
  directories:
    - ~/.cache
    - ~/.cache/Cypress
    - $HOME/.m2/repository
    - $HOME/.sbt
    - $HOME/.ivy2
    - $HOME/backend

env:
  - CASSANDRA_CLUSTER_HOSTS=localhost APP_PORT=2551

# Run the Platform
before_install:
  - "[ -d backend/.git ] || git clone https://github.com/cfpb/hmda-platform.git backend"
  - "cd backend"
  # Reset the repo so we can have a conflict-less pull
  - "git reset --hard"
  - "git clean -f"
  - "git pull"
  # Temporary: checkout branch with new config/test files
  - "git checkout generate-institution-test_data-for-travisci"
  - "git pull --rebase"
  # Trick to avoid unnecessary cache updates
  - find $HOME/.sbt -name "*.lock" | xargs rm
  - (sbt ++$TRAVIS_SCALA_VERSION  "project hmda-platform" "run" &)
  - "cd .."

install:
  - yarn install --offline

script:
  # Wait for the Platform to become available
  - ./cypress/wait-for-server.sh
  # Load test Institutions
  - yarn newman run backend/newman/tests/hmda-filing/tests/ci/CI_FRONTEND_FILING.postman_collection.json -e backend/newman/tests/hmda-filing/configs/ci/CI_FRONTEND_ENV_2018.postman_environment.json
  - yarn newman run backend/newman/tests/hmda-filing/tests/ci/CI_FRONTEND_FILING.postman_collection.json -e backend/newman/tests/hmda-filing/configs/ci/CI_FRONTEND_ENV_2019.postman_environment.json
  - yarn newman run backend/newman/tests/hmda-filing/tests/ci/CI_FRONTEND_FILING.postman_collection.json -e backend/newman/tests/hmda-filing/configs/ci/CI_FRONTEND_ENV_2020.postman_environment.json
  # Ensure cypress is available in Travis environment
  - cypress install
  # Start Frontend and run tests
  - REACT_APP_ENVIRONMENT='CI' yarn start -p 3000 &
  - $(npm bin)/cypress run --spec cypress/integration/filing/Filing.spec.js $RECORD
  # Cleanup
  - kill $(jobs -p) || true